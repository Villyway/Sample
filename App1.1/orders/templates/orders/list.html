{% extends "base.html" %}
{% load static %}
{% load product_extras %}

{% block title %}All Orders{% endblock %}

{% block css %}

{% endblock css %}

{% block next_page %}
<li class="breadcrumb-item text-muted active" aria-current="page"><a
  href="{% url 'orders:orders-list' %}">Orders</a> / <b class="text-dark">All<b></li>
{% endblock %}

{% block head %}
All Orders
{% endblock %}

{% block content %}

<div class="container-fluid mt-3 mb-5">
  <div class="row">
    {% comment %} <div class="col-4 mb-3">
      <div class="input-group">
        <label class="input-group-text" for="inputGroupSelect01">Categories</label>
        <select class="form-select" id="inputGroupSelect01">
          <option value="0" selected>Choose...</option>
          {% for category in categories %}
          <option value={{category.id}}>{{category.name}}</option>
          {% endfor %}
        </select>
      </div>
    </div> {% endcomment %}

    <div class="col-2">
      <label>Start Date</label>
      <input type="date" class="form-control mb-3" id="startDate" name="start_date" />      
    </div>
    <div class="col-2">
      <label>End Date</label>
      <input type="date" class="form-control mb-3" id="endDate" name="end_date" />      
    </div>
    
    <div class="col-2">
      <label>Order Dispatch Status</label>
      <select class="form-select" id="OrderDispatchStatus">
        <option value="choose" selected>Choose...</option>
        {% for status in order_dispatch_status %}
        <option value="{{status}}">{{status}}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-2">
      <label>Order Status</label>
      <select class="form-select" id="OrderStatus">
        <option value="choose" selected>Choose...</option>
        {% for status in order_status %}
        <option value="{{status}}">{{status}}</option>
        {% endfor %}
      </select>
    </div>
    

    <div class="col-3">
      <label>Search Input</label>
      <input type="text" class="form-control mb-3" id="id_search" name="search" placeholder="Search" />      
    </div>

    <div class="col-1">
      
      <button type="submit" class="form-control mt-4 btn-success" id="btn-search" name="search" placeholder="Search" />Search</button>      
    </div>
    
    <div class="col-12">

      <!-- Basic Bootstrap Table -->
      <div class="card">
        
        
        {% comment %} <a class="btn btn-success col-1">Add New</a> {% endcomment %}
        <div class="table-responsive text-nowrap text-left">
          <table class="table">
            <thead>
              <tr>
                <th>No</th>
                {% comment %} <th>Code</th> {% endcomment %}
                <th>Order No</th>
                <th>Date</th>
                <th>Customer Name</th>
                <th>Product</th>
                {% comment %} <th>sales_challan</th> {% endcomment %}
                <th>Status</th>              
                <th>Confirmation <br>Status</th>                
                <th>Action</th>
              </tr>
              
            </thead>
            <tbody class="table-border-bottom-1" id="id_products_list">
              {% for order in orders %}
              {% if order.order_confirmation == "IN REVIEW" %}
              <tr class=" alert-primary" >
              {% elif order.order_confirmation == "HOLD" %}
              <tr class="alert-danger" >
              {% else %}
              <tr >
              {% endif %}
              
                <td>
                {{ forloop.counter }}
                </td>
                <td><a href="{% url 'orders:order-details' order.id %}">{{order.order_no}}</a></td>
                <td>{{order.date|date:"d M, Y"}}</td>
                <td>{{order.customer.name}}</td>
                <td>
                  <div class="accordion-item">
                      <h2 class="accordion-header" id="flush-heading-{{ forloop.counter }}">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapse-{{ forloop.counter }}" aria-expanded="false" aria-controls="flush-collapse-{{ forloop.counter }}">
                              Products
                          </button>
                      </h2>
                      <div id="flush-collapse-{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="flush-heading-{{ forloop.counter }}" data-bs-parent="#accordionFlushExample">
                          <div class="accordion-body">
                            <table class="table">
                              <tr>
                                <th>Product code</th>
                                <th>Qty</th>
                                <th>Dispatch</br>Status</th>
                                <th>Status</th>
                              </tr>
                              {% if  order.orderofproduct_set.all %}
                              {% for i in order.orderofproduct_set.all %}
                              
                              {% if i.dispatch_status == 'DISPATCHED' and i.status == 'DELIVERED' %}
                              <tr>
                              {% elif i.dispatch_status == 'DISPATCHED' and i.status == 'IN TRANSPORT' %}
                              <tr class="bg-primary text-white">
                              {% elif i.dispatch_status == 'UNDER PROCESS' %}
                              <tr class="bg-warning">
                              {% elif i.dispatch_status == 'READY' %}
                              <tr class="bg-success">
                              {% elif i.dispatch_status == 'PENDING' %}
                              <tr class="bg-danger text-white">
                              {% else %}
                              <tr>
                              {% endif %}
                              
                                <td>{{i.product.code}}</td>
                                <td>{{i.order_qty}}/{{i.uom}}</td>
                                <td>{{i.dispatch_status}}</td>
                                <td>{{i.status}}</td>
                                
                              </tr>
                              {% endfor %}
                              {% else %}
                              No Product
                              {% endif %}
                            </table>
                          </div>
                      </div>
                  </div>
              </td>
                
                {% comment %} <td>{{order.sales_challan}}</td> {% endcomment %}
                <td>
                  {% if order.order_confirmation != 'CONFIRMED' %}
                  {{order.order_confirmation}}
                  {% else %}
                  {{order.order_status}}
                  {% endif %}
                  
                </td>
                <td>
                  {% if order.order_confirmation == 'CONFIRMED' %}
                  {{order.order_confirmation}}
                  {% else %}
                  <button class="btn btn-warning status-btn" data-order-id="{{ order.order_no }}">Confirmed</button>
                {% endif %}
                </td>                
                <td>
                  <a href="{% url 'orders:order-details' order.id %}" class="btn btn-success btn-circle " title="Publish"><i class="fa-regular fa-eye"></i></a>
                  {% comment %} <a href="{% url 'products:product-property' product.id %}"
                                class="btn btn-success btn-circle " title="Publish"><i class="fa-solid fa-magnet"></i></i></a>
                  
                  <a href="{% url 'products:products-edit' product.id %}" class="btn btn-primary btn-circle "
                                title="Product Edit"><i class="fas fa-edit" aria-hidden="true"></i></a>
                  <a href="" class="open-modal btn btn-danger btn-circle " data-toggle="modal"
                                data-target="" title="Delete"><i class="fa fa-trash"
                                    aria-hidden="true"></i></a> {% endcomment %}
                </td>
              </tr>
              {% endfor %}

            </tbody>
            <tfoot>
              <tr>
                <th>No</th>
                {% comment %} <th>Code</th> {% endcomment %}
                <th>Order No</th>
                <th>Date</th>
                <th>Customer Name</th>
                <th>Product</th>
                {% comment %} <th>sales_challan</th> {% endcomment %}
                <th>Status</th>              
                <th>Confirmation <br>Status</th>                
                <th>Action</th>
              </tr>
            </tfoot>
          </table>
          
        </div>
        
      </div>
      <!--/ Basic Bootstrap Table -->
    </div>
  </div>
  <div class="row container-fluid mt-2">
 
    {% if orders.paginator.num_pages > 1 %}    
    {% include 'components/pagination.html' with items=orders paginator=orders.paginator %}
    {% endif %}
</div>
</div>
<div class="mt-5"></div>

<!-- Modal -->
<div class="modal fade" id="basicModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel1">Order Confirmation </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form class="mt-3 " method="post" enctype="multipart/form-data" action='.'
                                    data-url='{{ request.build_absolute_uri|safe }}' id="add-lr">
                                    {% csrf_token %}
        <div class="col mb-3">
          <label for="nameBasic" class="form-label">Order No.</label>
          <input type="text" class="form-control" name="order_no" value="" readonly id="order-id"/>
        </select>
        </div>
        <div class="row">
          <div class="col mb-3">
            <label for="nameBasic" class="form-label">Order Confirmation Status:</label>
            <select name="status" class="form-control form-select" autofocus="" id="status">
              {% for i in confirm_status %}
              <option value="{{i}}" > {{i}} </option>
              {% endfor %}
              
          </select>
          </div>
        </div>
        <div class="row g-2">
          <div class="col mb-0">
            <label for="reson" class="form-label">Reason </label>
            <textarea id="reason" class="form-control" placeholder="Reason" name="reason"></textarea>
            {% comment %} <input type="text" id="reason" class="form-control" placeholder="Reason" /> {% endcomment %}
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <button type="submit" class="btn btn-primary">Change Status</button>
      </div>
    </form>
    </div>
  </div>
</div>

{% endblock content %}

{% block js %}
<script>
  $('#orders-menu').addClass('active open');
  $('#orders-list').addClass('active')
</script>

<script>
  $(document).on("click", "#btn-search", function () {
    var startDate = document.getElementById("startDate").value //endDate, OrderDispatchStatus, OrderStatus, id_search
    var endDate = document.getElementById("endDate").value
    var dispatchStatus = document.getElementById("OrderDispatchStatus")
    var orderStatus = document.getElementById("OrderStatus")
    var queryInput = document.getElementById("id_search").value
    var selectDispatch = dispatchStatus.options[dispatchStatus.selectedIndex].value
    var selectStatus = orderStatus.options[orderStatus.selectedIndex].value
    console.log(selectStatus,selectDispatch)
    
    $.ajax({
        url: '/orders/search/',
        type: 'GET',
        data: { 'query': queryInput, "dispatch_status":selectDispatch, "order_status":selectStatus, "start":startDate, "end":endDate},
        success: function (data) {
            $('#id_products_list').html(data.data);
        }
    });
});
</script>

<script>
  $(document).ready(function () {
      // Bind the click event to the button with class "status-btn"
      $('.status-btn').click(function () {
          // Get the data-order-id attribute from the clicked button
          var orderId = $(this).data('order-id');

          // Update the result div
          $('#basicModal').modal('show');
          document.getElementById('order-id').value = orderId;

          // Perform additional actions based on the selected option
          // Add your logic here
      });
  });
</script>

<script src="{% static 'js/jquery.form.js'%}"></script>
<script>
    
  $(document).ready(function () {
      var $myForm = $('#add-lr')
      $myForm.on("submit", function (event) {
          event.preventDefault()
          var formData = $(this).serialize()
          console.log(formData)
          var $thisURL = $myForm.attr('data-url') || window.location.href // or set your own url
          option = {
              method: "POST",
              url: $thisURL,
              data: formData,
              success: function (data) {
                  if (data.error) {
                      var message = "";
                      $("#error-message").html(message);
                      $('.toast').toast('show');
                  }
                  else {
                      location.replace(data.url)
                  }
              },
              error: function (data) {
                  $(".print_error").text("")
                  
              },
          }
          $myForm.ajaxSubmit(option)
      })
  })
</script>

<script>
  $(document).ready(function () {
      // Handle accordion behavior
      $('.accordion-button').on('click', function () {
          // Collapse all other accordion items
          $('.accordion-button').not(this).addClass('collapsed');
          $('.accordion-collapse').not($(this).next()).removeClass('show');
      });
  });
</script>

{% endblock js %}